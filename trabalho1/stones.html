<!DOCTYPE html>
<html>

  <head>

    <title>INF2610 - Rendering em Tempo Real: Bump Mapping</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8" />

    <link rel="icon" href="https://discoverthreejs.com/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="js/vendor/highlight/styles/github-gist.css">
    <script src="js/vendor/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link href="styles/main.css" rel="stylesheet" type="text/css">

    <!--

      Include the main three.js script.

      The global variable THREE will be
      available for use in any scripts
      loaded after this one.

    -->

    <script src="js/vendor/three/three.js"></script>

    <!--
      
      Include the WebGL, dat.gui, GLTFLoader and OrbitControls script.
      
      This must be included AFTER the three.js script as it
      needs to use the global THREE variable
      
    -->
    
    <script src="js/vendor/three/WebGL.js"></script>
    <script src="js/vendor/three/OrbitControls.js"></script>
    <script src="js/vendor/three/dat.gui.min.js"></script>
    <script src="js/vendor/three/GLTFLoader.js"></script>
    <script src="js/vendor/three/MTLLoader.js"></script>
    <script src="js/vendor/three/LoaderSupport.js"></script>
    <script src="js/vendor/three/OBJLoader2.js"></script>
    <script src="js/vendor/three/BufferGeometryUtils.js"></script>

  </head>

  <body>

    <div class="wrapper">
        <header class="header">
            <h1 class="title">Bump Mapping: Stones</h1>
            <h2 class="title">INF2610 - Rendering em Tempo Real</h2>
        </header>
      <article class="main">
        <div id="scene-container">
          <!-- This div will hold our scene-->
        </div>
      </article>
      <aside class="aside aside-1">
        <h2 class="title">Vertex Shader</h2>
        <pre>
          <code class="glsl" id="vertex-shader-code">
            VERTEX SHADER
          </code>
        </pre>
        
      </aside>
      <aside class="aside aside-2">
        <h2 class="title">Framgment Shader</h2>
        <pre>
          <code id="fragment-shader-code">
            FRAGMENT SHADER
          </code>
        </pre>
      </aside>
      <footer class="footer"></footer>
    </div>


    <script id="vs" type="x-shader/x-vertex">
      #version 300 es

      struct PointLight {
        vec3 color;
        vec3 position;
        float distance; 
      };

      /**
        https://threejs.org/docs/index.html#api/en/renderers/webgl/WebGLProgram
        Uniforms injected by Three.js:
        - position: vertex position
        - uv: texture coordinates
        - projectionMatrix: project matrix
        - modelViewMatrix: model view matrix
        - cameraPosition: camera position
      */

      // Point light array injected by Three.js
      uniform PointLight pointLights[NUM_POINT_LIGHTS];

      // Tangent generated by model loader OBJLoader2 
      attribute vec4 tangent;

      out vec4 color;       // diffuse color (not used)
      out vec2 vUv;         // texture coordinates
      out vec3 dirLight;    // light direction 
      out vec3 halfVector;  // vector at the half angle between viewer and light
      out mat3 TBN;         // Tangent Binormal Normal matrix

      void main() 
      {
        // Gerenating Tangent Binormal Normal matrix
        vec3 T = normalize(vec3(modelMatrix * tangent));
        vec3 N = normalize(vec3(modelMatrix * vec4(normal,    0.0)));
        vec3 B = normalize( cross(N, T) );
        TBN = ( mat3(T, B, N) );

        // Getting light direction from the 1st point light
        dirLight = pointLights[0].position - position;
        
        // Calculate half vector
        halfVector = normalize( dirLight + cameraPosition );
        
        // Just repassing the texture coordinates
        vUv = uv;

        // Using light color as default color
        color = vec4(pointLights[0].color, 1.0);

        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
  </script>
  <script id="fs" type="x-shader/x-fragment">
      #version 300 es

      precision highp float;
      precision highp int;

      in vec4 color;                // diffuse color (not used)
      in vec2 vUv;                  // texture coordinates
      in vec3 dirLight;             // light direction 
      in vec3 halfVector;           // vector between viewer and light
      in mat3 TBN;                  // Tangent Binormal Normal matrix
      
      uniform vec4 ka;              // ambient color
      uniform vec4 kd;              // diffuse color
      uniform vec4 ks;              // specular color
      uniform float shi;            // shininess
      uniform sampler2D bumpTex;    // normal texture
      uniform sampler2D diffuseTex; // diffuse texture

      // final color
      out vec4 out_FragColor;
      
      void main() 
      {
        // Obtain normal from normal map in range [0,1]
        vec3 normalTex = texture2D(bumpTex, vUv).xyz;

        // transform normal vector to range [-1,1]
        vec3 normal = normalize(-1.0 + 2.0*normalTex);

        // Normal in world space
        normal = normalize( TBN * normal );

        vec3 light = normalize(dirLight);

        // Compute lighting
        float NdotL = dot( normal, light );
        float diff = max( NdotL, 0.0 );

        // Calculate specular
        float spec = 0.0;
        if ( NdotL > 0.0 ) {
          vec3 halfv = normalize( halfVector );
          spec = pow( max( dot( normal, halfv ), 0.0 ), shi );
        }
        
        // diffuse color from texture
        vec4 diffuse = texture2D(diffuseTex, vUv) * diff;

        // final color
        out_FragColor = ka + diffuse + ks*spec;
      }
    </script>

    <!--
      Finally, include the script that
      runs your three.js app.
    -->

    <script src="js/app-stones.js"></script>

  </body>

</html>