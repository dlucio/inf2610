<!DOCTYPE html>
<html>

  <head>

    <title>INF2610 - Rendering em Tempo Real ( TEMPLATE )</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8" />

    <link rel="icon" href="https://discoverthreejs.com/favicon.ico" type="image/x-icon">

    <link href="styles/main.css" rel="stylesheet" type="text/css">

    <!--

      Include the main three.js script.

      The global variable THREE will be
      available for use in any scripts
      loaded after this one.

    -->

    <script src="js/vendor/three/three.js"></script>

    <!--
      
      Include all needed scripts.
      
      This must be included AFTER the three.js script as it
      needs to use the global THREE variable
      
    -->
    
    <script src="js/vendor/three/WebGL.js"></script>
    <script src="js/vendor/three/OrbitControls.js"></script>
    <script src="js/vendor/three/dat.gui.min.js"></script>
    <script src="js/vendor/three/GLTFLoader.js"></script>
    <script src="js/vendor/three/MTLLoader.js"></script>
    <script src="js/vendor/three/LoaderSupport.js"></script>
    <script src="js/vendor/three/OBJLoader2.js"></script>
    <script src="js/vendor/three/BufferGeometryUtils.js"></script>

  </head>

  <body>

    <h1 class="title">INF2610 - Rendering em Tempo Real ( BUMP MAPPING ) </h1>

    <div id="scene-container">
      <!-- This div will hold our scene-->
    </div>

    <script id="vs" type="x-shader/x-vertex">
      #version 300 es

      struct PointLight {
        vec3 color;
        vec3 position;
        float distance; 
      };

      /**
        https://threejs.org/docs/index.html#api/en/renderers/webgl/WebGLProgram
        Uniforms injected by Three.js:
        - position:
        - uv:
        - projectionMatrix:
        - modelViewMatrix:
        - cameraPosition:
      */

      uniform PointLight pointLights[NUM_POINT_LIGHTS];
      
      // Tangent generated from model mesh
      attribute vec4 tangent;
      
      out vec4 color;
      out vec2 vUv;
      out vec3 dirLight;
      out vec3 halfVector;
      out mat3 TBN;

      void main() 
      {

        vec4 bitangent = normalize( vec4( cross(normal, tangent.xyz), 0.0 ) );

        vec3 T = normalize(vec3(modelMatrix * tangent));
        vec3 B = normalize(vec3(modelMatrix * bitangent));
        vec3 N = normalize(vec3(modelMatrix * vec4(normal,    0.0)));
        TBN = ( mat3(T, B, N) );

        // Usando somente a primeira luz pontual
        dirLight = pointLights[0].position - position;
        
        halfVector = normalize( dirLight + cameraPosition );
        
        // Just repassing the UV 
        vUv = uv;

        // Using light color as default color
        color = vec4(pointLights[0].color, 1.0);

        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
  </script>
  <script id="fs" type="x-shader/x-fragment">
    #version 300 es

    precision highp float;
    precision highp int;

    in vec4 color;
    in vec2 vUv;
    in vec3 dirLight;
    in vec3 halfVector;
    in mat3 TBN;
    
    uniform vec4 ka;
    uniform vec4 kd;
    uniform vec4 ks;
    uniform float shi;
    uniform sampler2D bumpTex;

    out vec4 out_FragColor;

    void main() 
    {
      
      // obtain normal from normal map in range [0,1]
      vec3 normalTex = texture2D(bumpTex, vUv).xyz;

      // transform normal vector to range [-1,1]
      vec3 normal = normalize(-1.0 + 2.0*normalTex);

      // normal in tangent space
      normal = normalize( TBN * normal );

      vec3 light = normalize(dirLight);

      // compute lighting
      float NdotL = dot( normal, light );
      float diff = max( NdotL, 0.0 );

      float spec = 0.0;
      if ( NdotL > 0.0 ) {
        vec3 halfv = normalize( halfVector );
        //spec = pow( max( dot( normal, halfv ), 0.0 ), shi );
      }
      
      // diffuse color from light color
      vec4 diffuse = diff * color;

      // final color
      out_FragColor = ka + kd*diffuse + ks*spec;

    }
    </script>

    <!--
      Finally, include the script that
      runs your three.js app.
    -->

    <script src="js/app-golfball.js"></script>

  </body>

</html>